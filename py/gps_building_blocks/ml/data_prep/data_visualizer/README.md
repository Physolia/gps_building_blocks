# Data visualizer component ML Windowing pipeline

## Overview

Quality of ML models depends heavily on the quality of the training data. This
component helps ML model developers to explore a dataset thoroughly for quality
and consistency and decide which variables and data period to use in efficient
way. Specifically, it helps to explore in detail features generated by
[MLWindowingPipeline component](https://github.com/google/gps_building_blocks/tree/master/py/gps_building_blocks/ml/data_prep/ml_windowing_pipeline).

NOTE: The module currently supports only dataset for binary classification and
data needs to be stored in BigQuery.

The component has 3 main modules:

1.  [Instance visualizer](#instance-visualizer): used to visualize the
    statistics calculated from the Instance Table generated by the Data
    Exploration Pipeline of the
    [MLWindowingPipeline component](py/gps_building_blocks/ml/data_prep/ml_windowing_pipeline).
2.  [Fact visualizer](#fact-visualizer): used to visualize the statistics
    calculated from the Facts Table generated by the Data Exploration Pipeline
    of the
    [MLWindowingPipeline component](py/gps_building_blocks/ml/data_prep/ml_windowing_pipeline).
3.  [Feature visualizer](#feature-visualizer): used to visualize the statistics
    calculated from the Features Table generated by the Features Pipeline of the
    [MLWindowingPipeline component](py/gps_building_blocks/ml/data_prep/ml_windowing_pipeline)
    or any BigQuery table containing features and the label.

## Installation

```bash
pip install gps_building_blocks
```

## Usage examples

### Instance visualizer

Instance table in BigQuery is created by the `DataExplorationPipeline` of
[MLWindowingPipeline component](py/gps_building_blocks/ml/data_prep/ml_windowing_pipeline),
which contains the instances extracted for modeling over one or more snapshot
dates, their labels and two features namely, `daysSinceFirstActivity` and
`daysSinceLatestActivity`.

```python
from google.cloud import bigquery
from gps_building_blocks.py.ml.data_prep.data_visualizer import instance_visualizer

bq_client = bigquery.Client()
instance_viz = instance_visualizer.InstanceVisualizer(
        bq_client=bq_client,
        instance_table_path='project_id.dataset.instance_table',
        num_instances=100000,
        label_column='label',
        positive_class_label=True,
        negative_class_label=False)

instance_viz.plot_instances()
```

This generates plots with the number of total instances, number of positive
instances and proportion of positive instances for each snapshot. These plots
are helpful to understand how the label is distributed over time, whether there
are any inconsistencies and seasonality. Based on this we can drop specific
periods of snapshots having any issues and consider what features to add to
capture the seasonality or any trends over time.

In addition, this function also produces class specific distribution plots for
the `days_since_first_activity` and `days_since_latest_activity` feature in the
Instance table.

### Fact visualizer

Facts table in BigQuery is created by the `DataExplorationPipeline` of
`MLWindowingPipeline`, which contains the original GA variable transformed into
facts format containing `user_id`, `timestamp`, `fact_name` and `fact_value`.

```python
from google.cloud import bigquery
from gps_building_blocks.py.ml.data_prep.data_visualizer import fact_visualizer

bq_client = bigquery.Client(
fact_visualizer.FactVisualizer(
        bq_client=bq_client,
        facts_table_path='project_id.dataset.facts_table',
        numerical_facts=('num_fact_1', 'num_fact_2', 'num_fact_3'),
        categorical_facts=('cat_fact_1', 'cat _fact_2', 'cat_fact_3'),
        number_top_levels=10)

fact_visualizer.plot_facts()
```

This function produces plots of numerical and categorical fact variables which
can be used to explore their validity and distribution over time. Based on that
you can make decisions such as which features to use generate synthetic
features.

### Feature visualizer

This module can be used to visualize the statistics calculated from the Features
Table generated by the Features Pipeline of the ML Windowing Pipeline tool or
any BigQuery table containing features and the label.

```python
from google.cloud import bigquery
from gps_building_blocks.py.ml.data_prep.data_visualizer import feature_visualizer

bq_client = bigquery.Client(
feature_visualizer.FeatureVisualizer(
        bq_client=sbq_client,
        features_table_path='project_id.dataset.features_table',
        numerical_features=('num_feature_1', 'num_feature_2', 'num_feature_3'),
        categorical_features=(
            'cat_feature_1', 'cat_feature_2', 'cat_feature_3'),
        label_column='label',
        positive_class_label=True,
        negative_class_label=False,
        num_pos_instances=10000,
        num_neg_instances=10000)

feature_visualizer.plot_features()
```

This function produces class specific distribution plots of numerical and
categorical feature variables which can be used to explore their validity of the
features and potentially identify issues such as label leakage. Also it produces
the distribution of these features over time helping us to understand their
consistency.

From the distribution plots of the `daysSinceFirstActivity` and
`daysSinceLatestActivity` features for positive and negative class, you can
determine a good lookback window period to use to create features and whether
itâ€™s worth only using customers having a particular history and recently for
modeling.
