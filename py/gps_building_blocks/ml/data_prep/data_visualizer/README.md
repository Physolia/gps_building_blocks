# Data Visualizer Component ML Windowing pipeline

## Overview

Quality of ML models depends heavily on the quality of the training data. This
component helps ML model developers to explore a dataset thoroughly and
efficiently for quality and consistency, and decide which variables and periods
of data to use to create ML datasets. Specifically, it helps to explore the
inputs and outputs data of the
[ML Windowing Pipeline component](https://github.com/google/gps_building_blocks/tree/master/py/gps_building_blocks/ml/data_prep/ml_windowing_pipeline).

NOTE: The module currently supports exploring datasets for binary classification
models and data needs to be stored in Google Cloud BigQuery.

The component has 3 main modules:

1.  [Instance visualizer](#instance-visualizer): used to visualize the
    statistics calculated from the ML instances in the Instance Table generated
    by the Data Exploration Pipeline of the
    [ML Windowing Pipeline component](py/gps_building_blocks/ml/data_prep/ml_windowing_pipeline).
2.  [Fact visualizer](#fact-visualizer): used to visualize the statistics
    calculated from the numerical and categorical Fact Tables generated by the
    Data Exploration Pipeline of the
    [ML Windowing Pipeline component](py/gps_building_blocks/ml/data_prep/ml_windowing_pipeline).
3.  [Feature visualizer](#feature-visualizer): used to visualize the statistics
    calculated from the Features Table generated by the Features Pipeline of the
    [ML Windowing Pipeline component](py/gps_building_blocks/ml/data_prep/ml_windowing_pipeline)
    or any BigQuery table containing features and a binary label.

## Installation

```bash
pip install gps_building_blocks
```

## Usage examples

### Instance visualizer

Instance table in BigQuery is created by the `Data Exploration Pipeline` of
[ML Windowing Pipeline component](py/gps_building_blocks/ml/data_prep/ml_windowing_pipeline),
which contains the instances extracted for modeling over one or more snapshot
dates, their labels and two features, namely, `days_since_first_activity` and
`days_since_latest_activity`.

**Usage**

```python
from google.cloud import bigquery
from gps_building_blocks.ml.data_prep.data_visualizer import instance_visualizer

bq_client = bigquery.Client()
instance_viz = instance_visualizer.InstanceVisualizer(
        bq_client=bq_client,
        instance_table_path='project_id.dataset.instance_table',
        num_instances=100000,
        label_column='label',
        positive_class_label=True,
        negative_class_label=False)

instance_viz.plot_instances()
```

This generates plots with the number of total instances, number of positive
instances and proportion of positive instances for each snapshot. These plots
are helpful to understand how the label is distributed over time, seasonality
and trends and whether there are any inconsistencies. Based on this we can drop
specific periods of snapshots having any data issues and consider what
additional features to add to capture the seasonality or any trends of the label
over time.

In addition, this function also produces class specific distribution plots for
the `days_since_first_activity` and `days_since_latest_activity` features in the
Instance table. From these plots, we can determine a good lookback window period
to use to create features and whether itâ€™s worth only using customers having a
particular history and recency for modeling.

### Fact visualizer

Facts table in BigQuery is created by the `Data Exploration Pipeline` of
`ML Windowing Pipeline`, which contains the original GA variable transformed into
*facts* format containing `user_id`, `timestamp`, `fact_name` and `fact_value`.

**Usage**

```python
from google.cloud import bigquery
from gps_building_blocks.py.ml.data_prep.data_visualizer import fact_visualizer

bq_client = bigquery.Client(
fact_viz = fact_visualizer.FactVisualizer(
        bq_client=bq_client,
        numerical_facts_table_path='project_id.dataset.numerical_facts',
        categorical_facts_table_path='project_id.dataset.categorical_facts',
        number_top_categories=5)

fact_viz.plot_numerical_facts()

fact_viz.plot_categorical_facts()
```

`plot_numerical_facts()` and `plot_categorical_facts()` functions produces plots
of numerical and categorical fact variables, which can be used to explore their
validity and distribution over time. Based on that we can make decisions such as
which facts variables (and which levels in categorical fact variables) to use to
generate features later on.

### Feature visualizer

This module can be used to visualize the statistics calculated from the Features
Table generated by the `Features Pipeline` of the `ML Windowing Pipeline` tool or
any BigQuery table containing features and a binary label columns.

**Usage**

```python
from google.cloud import bigquery
from gps_building_blocks.py.ml.data_prep.data_visualizer import feature_visualizer

bq_client = bigquery.Client(
feature_viz = feature_visualizer.FeatureVisualizer(
        bq_client=sbq_client,
        features_table_path='project_id.dataset.features_table',
        numerical_features=('num_feature_1', 'num_feature_2', 'num_feature_3'),
        categorical_features=(
            'cat_feature_1', 'cat_feature_2', 'cat_feature_3'),
        label_column='label',
        positive_class_label=True,
        negative_class_label=False,
        num_pos_instances=10000,
        num_neg_instances=10000)

feature_viz.plot_features()
```

This function produces class specific distribution plots of numerical and
categorical features, which can be used to explore their validity of the
features and potentially identify issues such as label leakage. Also it produces
the distribution of these features over time helping us to understand their
consistency.
